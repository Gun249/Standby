<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>StandBy Mode PWA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Lora:wght@400;700&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">

    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; touch-action: manipulation; }
        html, body { overflow: hidden; }
        .view, .modal { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .hidden-view { opacity: 0; pointer-events: none; transform: scale(0.95); }
        .visible-view { opacity: 1; transform: scale(1); }
        .background-media {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
        }
        #main-background {
            background-size: cover;
            background-position: center;
            transition-property: background-image, opacity;
            transition-duration: 1.5s;
            transition-timing-function: ease-in-out;
        }
        #bg-video { object-fit: cover; }
        /* Custom file/color input */
        input[type="file"] { display: none; }
        .custom-file-upload { border: 1px solid #4a5568; display: inline-block; padding: 6px 12px; cursor: pointer; background-color: #2d3748; border-radius: 0.5rem; text-align: center; }
        input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 48px; height: 32px; background-color: transparent; border: none; cursor: pointer; }
        input[type="color"]::-webkit-color-swatch { border-radius: 0.25rem; border: 1px solid #4a5568; }
        input[type="color"]::-moz-color-swatch { border-radius: 0.25rem; border: 1px solid #4a5568; }
        /* Opacity Slider Thumb */
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 24px; height: 24px; background: #ef4444; cursor: pointer; border-radius: 50%; }
        input[type=range]::-moz-range-thumb { width: 24px; height: 24px; background: #ef4444; cursor: pointer; border-radius: 50%; }
    </style>
</head>
<body class="bg-black text-white h-screen w-screen flex items-center justify-center select-none">

    <!-- Main Container -->
    <div id="app" class="h-full w-full relative">

        <!-- Portrait View -->
        <div id="portrait-view" class="view visible-view absolute inset-0 flex flex-col items-center justify-center text-center p-8">
            <div id="portrait-icon"></div>
            <h1 id="portrait-title" class="text-2xl font-bold mb-2">โหมด StandBy</h1>
            <p id="portrait-text" class="text-gray-400">กรุณาหมุนอุปกรณ์เป็นแนวนอน<br>เพื่อเข้าสู่โหมดพักหน้าจอ</p>
            <button id="settings-btn" class="absolute top-5 right-5 p-2 text-gray-400 hover:text-white transition">
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 0 1-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.57 6.57 0 0 1-.22.127c-.332.183-.582.495-.645.87l-.213 1.281c-.09.543-.56.94-1.11.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 0 1-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 0 1-1.37-.49l-1.296-2.247a1.125 1.125 0 0 1 .26-1.431l1.003-.827c.293-.24.438-.613.438-.995s-.145-.755-.438-.995l-1.003-.827a1.125 1.125 0 0 1-.26-1.431l1.296-2.247a1.125 1.125 0 0 1 1.37-.49l1.217.456c.355.133.75.072 1.075-.124.073-.044.146-.087.22-.127.332-.183.582-.495-.645-.87l.213-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
            </button>
        </div>

        <!-- StandBy View (Landscape) -->
        <div id="standby-view" class="view hidden-view absolute inset-0 p-4 sm:p-8">
            <div id="main-background" class="background-media"></div>
            <video id="bg-video" class="background-media" muted loop playsinline></video>
            
            <div class="relative z-10 grid grid-cols-1 lg:grid-cols-2 gap-4 h-full">
                <div id="clock-wrapper" class="flex items-center justify-center transition-opacity duration-300 cursor-pointer">
                    <div class="text-center w-full h-full flex flex-col items-center justify-center">
                        <div id="clock-face-container" class="relative w-full flex-grow flex items-center justify-center">
                            <div id="digital-time" class="font-black" style="font-size: clamp(3rem, min(22vw, 35vh), 12rem); line-height: 1;">00:00:00</div>
                            <canvas id="analog-clock-canvas" class="hidden absolute top-0 left-0"></canvas>
                        </div>
                        <div id="date" class="font-bold mt-2" style="font-size: clamp(1rem, min(5vw, 7vh), 2.5rem);">วันที่</div>
                        <div id="secondary-clock" class="font-semibold mt-3" style="font-size: clamp(1rem, min(5vw, 7vh), 2.5rem);"></div>
                    </div>
                </div>
                <div class="flex items-center justify-center">
                    <div id="weather-widget" class="hidden bg-black/30 backdrop-blur-md rounded-2xl p-6 text-center"></div>
                </div>
            </div>
        </div>

        <!-- Opacity Slider Modal -->
        <div id="opacity-modal" class="modal hidden-view absolute inset-0 bg-black/50 flex items-center justify-center p-8 z-30">
            <input type="range" id="live-opacity-slider" min="0.2" max="1" step="0.05" class="w-full max-w-md h-3 bg-gray-700 rounded-lg appearance-none cursor-pointer">
        </div>

        <!-- Settings Modal -->
        <div id="settings-modal" class="modal hidden-view absolute inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 z-30">
            <div class="bg-gray-900 rounded-2xl p-6 w-full max-w-md max-h-full overflow-y-auto">
                <h2 class="text-xl font-bold mb-6">ตั้งค่าการแสดงผล</h2>
                <div class="space-y-6">
                    <!-- Clock Settings -->
                    <div>
                        <h3 class="font-bold mb-2">นาฬิกา</h3>
                        <div class="space-y-4 p-4 bg-gray-800 rounded-lg">
                            <label class="block"><span class="text-gray-300">รูปแบบนาฬิกา</span><select id="clock-type-select" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"><option value="digital">ดิจิทัล</option><option value="analog">เข็ม</option></select></label>
                            <label class="block"><span class="text-gray-300">โซนเวลาหลัก</span><select id="timezone-select-1" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"></select></label>
                            <label class="block"><span class="text-gray-300">โซนเวลาที่สอง</span><select id="timezone-select-2" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"></select></label>
                            <label class="block"><span class="text-gray-300">รูปแบบปี</span><select id="year-format-select" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500"><option value="buddhist">พ.ศ.</option><option value="gregory">ค.ศ.</option></select></label>
                        </div>
                    </div>
                    <!-- Widget & Background Settings -->
                    <div>
                        <h3 class="font-bold mb-2">วิดเจ็ตและพื้นหลัง</h3>
                        <div class="space-y-4 p-4 bg-gray-800 rounded-lg">
                            <label class="flex items-center justify-between"><span class="text-gray-300">พยากรณ์อากาศ</span><input type="checkbox" id="weather-toggle" class="h-6 w-6 rounded text-red-500 focus:ring-red-500"></label>
                            <hr class="border-gray-700">
                            <label class="flex items-center justify-between"><span class="text-gray-300">แสดงภาพพื้นหลัง</span><input type="checkbox" id="photo-toggle" class="h-6 w-6 rounded text-red-500 focus:ring-red-500"></label>
                            <div id="background-options-container" class="hidden space-y-2 pt-2">
                                <select id="bg-mode-select" class="block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                                    <option value="random">สุ่มภาพอัตโนมัติ</option>
                                    <option value="custom">อัปโหลดไฟล์เอง</option>
                                </select>
                                <div id="custom-bg-upload-container" class="hidden">
                                    <label for="bg-file-input" class="custom-file-upload w-full">เลือกไฟล์ภาพหรือวิดีโอ</label>
                                    <input id="bg-file-input" type="file" accept="image/*,video/*">
                                    <p id="custom-bg-filename" class="text-xs text-gray-400 mt-2 truncate"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                     <!-- Color & Font Settings -->
                    <div>
                        <h3 class="font-bold mb-2">สีและฟอนต์</h3>
                        <div class="space-y-4 p-4 bg-gray-800 rounded-lg">
                            <div id="background-color-container">
                                <label class="flex items-center justify-between"><span class="text-gray-300">สีพื้นหลัง</span><input type="color" id="bg-color-input"></label>
                            </div>
                            <label class="flex items-center justify-between"><span class="text-gray-300">สีนาฬิกาหลัก/เข็ม</span><input type="color" id="primary-color-input"></label>
                            <label class="flex items-center justify-between"><span class="text-gray-300">สีข้อความรอง</span><input type="color" id="secondary-color-input"></label>
                             <label class="block"><span class="text-gray-300">รูปแบบฟอนต์</span><select id="font-family-select" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                                <option value="'Inter', sans-serif">Inter (มาตรฐาน)</option>
                                <option value="'Lora', serif">Lora (มีหัว)</option>
                                <option value="'Roboto Mono', monospace">Roboto Mono (ดิจิทัล)</option>
                            </select></label>
                        </div>
                    </div>
                </div>
                <button id="close-settings-btn" class="mt-8 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-4 rounded-lg transition">บันทึกและปิด</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements & State Initialization ---
        const elements = {
            app: document.getElementById('app'),
            mainBackground: document.getElementById('main-background'),
            bgVideo: document.getElementById('bg-video'),
            clockWrapper: document.getElementById('clock-wrapper'),
            digitalTime: document.getElementById('digital-time'),
            analogClockCanvas: document.getElementById('analog-clock-canvas'),
            date: document.getElementById('date'),
            secondaryClock: document.getElementById('secondary-clock'),
            portraitView: document.getElementById('portrait-view'),
            standbyView: document.getElementById('standby-view'),
            portraitIcon: document.getElementById('portrait-icon'),
            portraitTitle: document.getElementById('portrait-title'),
            portraitText: document.getElementById('portrait-text'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            opacityModal: document.getElementById('opacity-modal'),
            liveOpacitySlider: document.getElementById('live-opacity-slider'),
            weatherToggle: document.getElementById('weather-toggle'),
            photoToggle: document.getElementById('photo-toggle'),
            weatherWidget: document.getElementById('weather-widget'),
            backgroundOptionsContainer: document.getElementById('background-options-container'),
            backgroundColorContainer: document.getElementById('background-color-container'),
            clockTypeSelect: document.getElementById('clock-type-select'),
            timezoneSelect1: document.getElementById('timezone-select-1'),
            timezoneSelect2: document.getElementById('timezone-select-2'),
            yearFormatSelect: document.getElementById('year-format-select'),
            bgModeSelect: document.getElementById('bg-mode-select'),
            customBgUploadContainer: document.getElementById('custom-bg-upload-container'),
            bgFileInput: document.getElementById('bg-file-input'),
            customBgFilename: document.getElementById('custom-bg-filename'),
            bgColorInput: document.getElementById('bg-color-input'),
            primaryColorInput: document.getElementById('primary-color-input'),
            secondaryColorInput: document.getElementById('secondary-color-input'),
            fontFamilySelect: document.getElementById('font-family-select'),
        };

        let state = {
            wakeLock: null,
            clockInterval: null,
            photoInterval: null,
            isCharging: false,
            longPressTimer: null,
            settings: {
                showWeather: false,
                showPhotos: false,
                clockType: 'digital', // 'digital', 'analog'
                timeZone1: 'Asia/Bangkok',
                timeZone2: 'Europe/London',
                yearFormat: 'buddhist',
                clockOpacity: 1.0,
                backgroundMode: 'random',
                backgroundType: 'random',
                customBgUrl: null,
                backgroundColor: '#000000',
                primaryColor: '#ef4444',
                secondaryColor: '#ffffff',
                fontFamily: "'Inter', sans-serif",
            }
        };

        const icons = {
            landscape: `<svg class="w-16 h-16 mb-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" /></svg>`,
            charging: `<svg class="w-16 h-16 mb-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" /></svg>`
        };
        
        const timezoneToCountryCode = {
            'Asia/Bangkok': 'TH', 'Europe/London': 'GB', 'Asia/Tokyo': 'JP', 'America/New_York': 'US', 'Australia/Sydney': 'AU', 'Europe/Paris': 'FR', 'Asia/Dubai': 'AE', 'Asia/Hong_Kong': 'HK', 'America/Los_Angeles': 'US', 'UTC': 'UN'
        };

        // --- Settings Management ---
        const saveSettings = () => localStorage.setItem('standbySettings_v8', JSON.stringify(state.settings));

        const loadSettings = () => {
            const saved = localStorage.getItem('standbySettings_v8');
            if (saved) {
                state.settings = { ...state.settings, ...JSON.parse(saved) };
            }
            elements.weatherToggle.checked = state.settings.showWeather;
            elements.photoToggle.checked = state.settings.showPhotos;
            elements.clockTypeSelect.value = state.settings.clockType;
            elements.timezoneSelect1.value = state.settings.timeZone1;
            elements.timezoneSelect2.value = state.settings.timeZone2;
            elements.yearFormatSelect.value = state.settings.yearFormat;
            elements.bgModeSelect.value = state.settings.backgroundMode;
            elements.customBgFilename.textContent = state.settings.customBgUrl ? "มีไฟล์ที่อัปโหลดไว้แล้ว" : "";
            elements.bgColorInput.value = state.settings.backgroundColor;
            elements.primaryColorInput.value = state.settings.primaryColor;
            elements.secondaryColorInput.value = state.settings.secondaryColor;
            elements.fontFamilySelect.value = state.settings.fontFamily;
            
            toggleBackgroundOptions();
            applyBackgroundMode();
            applyColorAndFontSettings();
            toggleClockTypeView();
        };

        // --- UI Application Functions ---
        const applyClockOpacity = () => elements.clockWrapper.style.opacity = state.settings.clockOpacity;
        
        const applyColorAndFontSettings = () => {
            document.body.style.backgroundColor = state.settings.backgroundColor;
            elements.digitalTime.style.color = state.settings.primaryColor;
            elements.date.style.color = state.settings.secondaryColor;
            elements.secondaryClock.style.color = state.settings.secondaryColor;
            elements.app.style.fontFamily = state.settings.fontFamily;
        };

        const toggleBackgroundOptions = () => {
            const showPhotos = state.settings.showPhotos;
            elements.backgroundOptionsContainer.style.display = showPhotos ? 'block' : 'none';
            elements.backgroundColorContainer.style.display = showPhotos ? 'none' : 'flex';
        };

        const applyBackgroundMode = () => {
            elements.customBgUploadContainer.style.display = state.settings.backgroundMode === 'custom' ? 'block' : 'none';
        };

        const toggleClockTypeView = () => {
            if (state.settings.clockType === 'analog') {
                elements.digitalTime.classList.add('hidden');
                elements.analogClockCanvas.classList.remove('hidden');
            } else {
                elements.digitalTime.classList.remove('hidden');
                elements.analogClockCanvas.classList.add('hidden');
            }
        };

        // --- Wake Lock ---
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try { state.wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.error('Wake Lock failed:', err); }
            }
        };
        const releaseWakeLock = async () => {
            if (state.wakeLock) { await state.wakeLock.release(); }
        };

        // --- Clock Drawing ---
        function getFlagEmoji(countryCode) {
            if (!countryCode) return '🏳️';
            const codePoints = countryCode.toUpperCase().split('').map(char => 127397 + char.charCodeAt());
            return String.fromCodePoint(...codePoints);
        }

        function drawAnalogClock(now) {
            const canvas = elements.analogClockCanvas;
            const ctx = canvas.getContext('2d');
            const container = canvas.parentElement;
            
            const size = Math.min(container.offsetWidth, container.offsetHeight) * 0.9;
            canvas.width = size;
            canvas.height = size;
            
            const radius = size / 2;
            ctx.translate(radius, radius);

            // Draw face
            ctx.beginPath();
            ctx.arc(0, 0, radius * 0.95, 0, 2 * Math.PI);
            ctx.fillStyle = 'transparent';
            ctx.fill();
            ctx.strokeStyle = state.settings.secondaryColor;
            ctx.lineWidth = radius * 0.05;
            ctx.stroke();
            
            // Draw center
            ctx.beginPath();
            ctx.arc(0, 0, radius * 0.05, 0, 2 * Math.PI);
            ctx.fillStyle = state.settings.primaryColor;
            ctx.fill();

            // Draw numbers
            ctx.font = `bold ${radius * 0.15}px ${state.settings.fontFamily}`;
            ctx.fillStyle = state.settings.secondaryColor;
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            for(let num = 1; num <= 12; num++){
                let ang = num * Math.PI / 6;
                ctx.rotate(ang);
                ctx.translate(0, -radius * 0.8);
                ctx.rotate(-ang);
                ctx.fillText(num.toString(), 0, 0);
                ctx.rotate(ang);
                ctx.translate(0, radius * 0.8);
                ctx.rotate(-ang);
            }

            // Draw hands
            const hour = now.getHours() % 12;
            const minute = now.getMinutes();
            const second = now.getSeconds();

            // Hour hand
            let hourAngle = (hour*Math.PI/6) + (minute*Math.PI/(6*60)) + (second*Math.PI/(360*60));
            drawHand(ctx, hourAngle, radius*0.5, radius*0.07, state.settings.primaryColor);
            // Minute hand
            let minuteAngle = (minute*Math.PI/30) + (second*Math.PI/(30*60));
            drawHand(ctx, minuteAngle, radius*0.75, radius*0.05, state.settings.primaryColor);
            // Second hand
            let secondAngle = (second*Math.PI/30);
            drawHand(ctx, secondAngle, radius*0.85, radius*0.02, state.settings.primaryColor);

            ctx.translate(-radius, -radius); // Reset translation
        }

        function drawHand(ctx, pos, length, width, color) {
            ctx.beginPath();
            ctx.lineWidth = width;
            ctx.lineCap = "round";
            ctx.strokeStyle = color;
            ctx.moveTo(0,0);
            ctx.rotate(pos);
            ctx.lineTo(0, -length);
            ctx.stroke();
            ctx.rotate(-pos);
        }

        const updateClock = () => {
            const now = new Date();
            // Get time for the primary timezone
            const primaryNowStr = now.toLocaleString('en-US', { timeZone: state.settings.timeZone1 });
            const primaryNow = new Date(primaryNowStr);

            if (state.settings.clockType === 'analog') {
                drawAnalogClock(primaryNow);
            } else {
                const mainTimeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: state.settings.timeZone1 };
                elements.digitalTime.textContent = now.toLocaleTimeString('en-US', mainTimeOptions);
            }
            
            const mainDateOptions = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', timeZone: state.settings.timeZone1, calendar: state.settings.yearFormat };
            elements.date.textContent = now.toLocaleDateString('th-TH', mainDateOptions);
            
            const secondaryTimeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false, timeZone: state.settings.timeZone2 };
            const secondaryTimeString = now.toLocaleTimeString('en-US', secondaryTimeOptions);
            const countryCode = timezoneToCountryCode[state.settings.timeZone2];
            const flag = getFlagEmoji(countryCode);
            elements.secondaryClock.innerHTML = `<span>${flag}</span> ${secondaryTimeString}`;
        };

        const updateBackgroundMedia = () => {
            if (state.photoInterval) clearInterval(state.photoInterval);
            elements.bgVideo.pause();
            elements.mainBackground.style.opacity = '0';
            elements.bgVideo.style.opacity = '0';
            const mode = state.settings.backgroundMode;
            const type = state.settings.backgroundType;
            if (mode === 'random') {
                const updateRandomImage = () => {
                    const query = ['nature', 'water', 'sky', 'city', 'abstract', 'technology'][Math.floor(Math.random() * 6)];
                    elements.mainBackground.style.backgroundImage = `url(https://source.unsplash.com/random/1280x720?${query}&t=${new Date().getTime()})`;
                    elements.mainBackground.style.opacity = '1';
                };
                updateRandomImage();
                state.photoInterval = setInterval(updateRandomImage, 20000);
            } else if (mode === 'custom' && state.settings.customBgUrl) {
                if (type === 'image') {
                    elements.mainBackground.style.backgroundImage = `url(${state.settings.customBgUrl})`;
                    elements.mainBackground.style.opacity = '1';
                } else if (type === 'video') {
                    elements.bgVideo.src = state.settings.customBgUrl;
                    elements.bgVideo.play();
                    elements.bgVideo.style.opacity = '1';
                }
            }
        };

        const stopAllMedia = () => {
            if (state.photoInterval) clearInterval(state.photoInterval);
            elements.bgVideo.pause();
            elements.mainBackground.style.opacity = '0';
            elements.bgVideo.style.opacity = '0';
        };

        const getWeatherDescription = (code) => {
            const d = {0: "ท้องฟ้าแจ่มใส", 1: "ส่วนใหญ่แจ่มใส", 2: "มีเมฆบางส่วน", 3: "มีเมฆมาก", 45: "มีหมอก", 61: "ฝนตกเล็กน้อย", 95: "พายุฝนฟ้าคะนอง"};
            return d[code] || "ไม่ทราบสภาพอากาศ";
        };

        const fetchWeather = () => {
            elements.weatherWidget.innerHTML = `<p>กำลังโหลด...</p>`;
            navigator.geolocation.getCurrentPosition(async p => {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`;
                try {
                    const r = await fetch(url);
                    const d = await r.json();
                    elements.weatherWidget.innerHTML = `<p class="text-5xl font-bold">${Math.round(d.current_weather.temperature)}°C</p><p class="mt-2">${getWeatherDescription(d.current_weather.weathercode)}</p>`;
                } catch (e) {
                    elements.weatherWidget.innerHTML = `<p>โหลดข้อมูลไม่ได้</p>`;
                }
            }, () => {
                elements.weatherWidget.innerHTML = `<p>โปรดเปิดตำแหน่ง</p>`;
            });
        };

        const updateWidgetVisibility = () => {
            elements.weatherWidget.style.display = state.settings.showWeather ? 'block' : 'none';
            if (state.settings.showWeather) fetchWeather();
            if (state.settings.showPhotos) {
                updateBackgroundMedia();
            } else {
                stopAllMedia();
            }
        };

        const handleStateChange = () => {
            const isLandscape = screen.orientation.type.includes('landscape');
            if (isLandscape && state.isCharging) {
                elements.portraitView.classList.replace('visible-view', 'hidden-view');
                elements.standbyView.classList.replace('hidden-view', 'visible-view');
                requestWakeLock();
                updateClock();
                if (state.clockInterval) clearInterval(state.clockInterval);
                state.clockInterval = setInterval(updateClock, 1000);
                updateWidgetVisibility();
                applyClockOpacity();
                applyColorAndFontSettings();
            } else {
                elements.standbyView.classList.replace('visible-view', 'hidden-view');
                elements.portraitView.classList.replace('hidden-view', 'visible-view');
                releaseWakeLock();
                if (state.clockInterval) clearInterval(state.clockInterval);
                stopAllMedia();
                updatePortraitMessage();
            }
        };

        const updatePortraitMessage = () => {
            if (state.isCharging) {
                elements.portraitIcon.innerHTML = icons.landscape;
                elements.portraitTitle.textContent = "พร้อมทำงาน";
                elements.portraitText.innerHTML = "กรุณาหมุนอุปกรณ์เป็นแนวนอน";
            } else {
                elements.portraitIcon.innerHTML = icons.charging;
                elements.portraitTitle.textContent = "กรุณาเสียบสายชาร์จ";
                elements.portraitText.innerHTML = "โหมด StandBy จะทำงานเมื่อ<br>อุปกรณ์ของคุณกำลังชาร์จไฟ";
            }
        };

        const populateTimezones = () => {
            const timezones = Object.keys(timezoneToCountryCode);
            [elements.timezoneSelect1, elements.timezoneSelect2].forEach(select => {
                select.innerHTML = '';
                timezones.forEach(tz => {
                    const option = document.createElement('option');
                    option.value = tz;
                    option.textContent = tz;
                    select.appendChild(option);
                });
            });
        };

        const setupEventListeners = () => {
            elements.settingsBtn.addEventListener('click', () => elements.settingsModal.classList.replace('hidden-view', 'visible-view'));
            elements.closeSettingsBtn.addEventListener('click', () => {
                elements.settingsModal.classList.replace('visible-view', 'hidden-view');
                saveSettings();
                handleStateChange();
            });
            const startPress = (e) => {
                e.preventDefault();
                state.longPressTimer = setTimeout(() => {
                    elements.opacityModal.classList.replace('hidden-view', 'visible-view');
                    elements.liveOpacitySlider.value = state.settings.clockOpacity;
                }, 500);
            };
            const cancelPress = () => clearTimeout(state.longPressTimer);
            elements.clockWrapper.addEventListener('mousedown', startPress);
            elements.clockWrapper.addEventListener('touchstart', startPress, { passive: false });
            elements.clockWrapper.addEventListener('mouseup', cancelPress);
            elements.clockWrapper.addEventListener('mouseleave', cancelPress);
            elements.clockWrapper.addEventListener('touchend', cancelPress);
            elements.liveOpacitySlider.addEventListener('input', e => {
                state.settings.clockOpacity = e.target.value;
                applyClockOpacity();
            });
            elements.opacityModal.addEventListener('click', (e) => {
                if (e.target === elements.opacityModal) {
                    elements.opacityModal.classList.replace('visible-view', 'hidden-view');
                    saveSettings();
                }
            });
            elements.weatherToggle.addEventListener('change', e => state.settings.showWeather = e.target.checked);
            elements.photoToggle.addEventListener('change', e => {
                state.settings.showPhotos = e.target.checked;
                toggleBackgroundOptions();
            });
            elements.clockTypeSelect.addEventListener('change', e => {
                state.settings.clockType = e.target.value;
                toggleClockTypeView();
            });
            elements.timezoneSelect1.addEventListener('change', e => state.settings.timeZone1 = e.target.value);
            elements.timezoneSelect2.addEventListener('change', e => state.settings.timeZone2 = e.target.value);
            elements.yearFormatSelect.addEventListener('change', e => state.settings.yearFormat = e.target.value);
            elements.bgModeSelect.addEventListener('change', e => {
                state.settings.backgroundMode = e.target.value;
                applyBackgroundMode();
            });
            elements.bgFileInput.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        state.settings.customBgUrl = event.target.result;
                        state.settings.backgroundType = 'image';
                        elements.customBgFilename.textContent = file.name;
                        saveSettings();
                    };
                    reader.readAsDataURL(file);
                } else if (file.type.startsWith('video/')) {
                    const url = URL.createObjectURL(file);
                    state.settings.customBgUrl = url;
                    state.settings.backgroundType = 'video';
                    elements.customBgFilename.textContent = file.name;
                    saveSettings();
                }
            });
            elements.bgColorInput.addEventListener('input', e => {
                state.settings.backgroundColor = e.target.value;
                applyColorAndFontSettings();
            });
            elements.primaryColorInput.addEventListener('input', e => {
                state.settings.primaryColor = e.target.value;
                applyColorAndFontSettings();
            });
            elements.secondaryColorInput.addEventListener('input', e => {
                state.settings.secondaryColor = e.target.value;
                applyColorAndFontSettings();
            });
            elements.fontFamilySelect.addEventListener('change', e => {
                state.settings.fontFamily = e.target.value;
                applyColorAndFontSettings();
            });
            screen.orientation.addEventListener('change', handleStateChange);
        };

        const setupBatteryListener = () => {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    state.isCharging = battery.charging;
                    battery.addEventListener('chargingchange', () => {
                        state.isCharging = battery.charging;
                        handleStateChange();
                    });
                    handleStateChange();
                });
            } else {
                state.isCharging = true;
                handleStateChange();
            }
        };
        
        window.addEventListener('load', () => {
            populateTimezones();
            loadSettings();
            applyClockOpacity();
            setupEventListeners();
            setupBatteryListener();
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js');
            }
        });
    </script>
</body>
</html>
