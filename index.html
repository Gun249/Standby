<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StandBy Mode PWA</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Theme color for browser UI -->
    <meta name="theme-color" content="#000000">

    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        html, body {
            overflow: hidden;
        }
        .view {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        .hidden-view {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.95);
        }
        .visible-view {
            opacity: 1;
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-black text-white h-screen w-screen flex items-center justify-center select-none">

    <!-- Main Application Container -->
    <div id="app" class="h-full w-full relative">

        <!-- Portrait View: Instructions for the user -->
        <div id="portrait-view" class="view visible-view absolute inset-0 flex flex-col items-center justify-center text-center p-8">
            <div id="portrait-icon">
                <!-- Icon will be injected by JS -->
            </div>
            <h1 id="portrait-title" class="text-2xl font-bold mb-2">โหมด StandBy</h1>
            <p id="portrait-text" class="text-gray-400">กรุณาหมุนอุปกรณ์เป็นแนวนอน<br>เพื่อเข้าสู่โหมดพักหน้าจอ</p>
        </div>

        <!-- StandBy View (Landscape): The main clock display -->
        <div id="standby-view" class="view hidden-view absolute inset-0 flex flex-col items-center justify-center p-4 sm:p-8">
            <div class="text-center">
                <div id="time" class="font-black text-red-500" style="font-size: clamp(4rem, 25vw, 15rem); line-height: 1;">00:00</div>
                <div id="date" class="font-bold text-white mt-2" style="font-size: clamp(1rem, 5vw, 2.5rem);">วันที่</div>
            </div>
        </div>

    </div>

    <script>
        // DOM Element References
        const portraitView = document.getElementById('portrait-view');
        const standbyView = document.getElementById('standby-view');
        const timeEl = document.getElementById('time');
        const dateEl = document.getElementById('date');
        const portraitIcon = document.getElementById('portrait-icon');
        const portraitTitle = document.getElementById('portrait-title');
        const portraitText = document.getElementById('portrait-text');

        // State variables
        let wakeLock = null;
        let clockInterval = null;
        let isCharging = false;

        // --- Icons ---
        const landscapeIcon = `<svg class="w-16 h-16 mb-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" /></svg>`;
        const chargingIcon = `<svg class="w-16 h-16 mb-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" /></svg>`;

        // --- Wake Lock API Functions ---
        const requestWakeLock = async () => {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock is active.');
                } catch (err) { console.error(`Wake Lock failed: ${err.name}, ${err.message}`); }
            }
        };

        const releaseWakeLock = async () => {
            if (wakeLock !== null) {
                await wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock released.');
            }
        };

        // --- Clock and Date Functions ---
        const updateClock = () => {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            timeEl.textContent = `${hours}:${minutes}`;
            const dateOptions = { weekday: 'long', day: 'numeric', month: 'long' };
            dateEl.textContent = now.toLocaleDateString('th-TH', dateOptions);
        };

        // --- UI Update Function ---
        const updatePortraitMessage = () => {
            const isLandscape = screen.orientation.type.includes('landscape');
            if (!isLandscape) {
                 if (isCharging) {
                    portraitIcon.innerHTML = landscapeIcon;
                    portraitTitle.textContent = "โหมด StandBy พร้อมทำงาน";
                    portraitText.innerHTML = "กรุณาหมุนอุปกรณ์เป็นแนวนอน<br>เพื่อเข้าสู่โหมดพักหน้าจอ";
                } else {
                    portraitIcon.innerHTML = chargingIcon;
                    portraitTitle.textContent = "กรุณาเสียบสายชาร์จ";
                    portraitText.innerHTML = "โหมด StandBy จะทำงานเมื่อ<br>อุปกรณ์ของคุณกำลังชาร์จไฟ";
                }
            }
        };

        // --- Core Logic ---
        const handleStateChange = () => {
            const isLandscape = screen.orientation.type.includes('landscape');

            if (isLandscape && isCharging) {
                // --- Enter StandBy Mode ---
                portraitView.classList.replace('visible-view', 'hidden-view');
                standbyView.classList.replace('hidden-view', 'visible-view');
                requestWakeLock();
                updateClock();
                if (clockInterval) clearInterval(clockInterval);
                // Update once a minute is enough if not showing seconds, saves battery
                clockInterval = setInterval(updateClock, 60 * 1000); 
            } else {
                // --- Exit StandBy Mode ---
                standbyView.classList.replace('visible-view', 'hidden-view');
                portraitView.classList.replace('hidden-view', 'visible-view');
                releaseWakeLock();
                if (clockInterval) {
                    clearInterval(clockInterval);
                    clockInterval = null;
                }
                // Update the message in portrait mode based on charging state
                updatePortraitMessage();
            }
        };

        // --- Battery API ---
        const setupBatteryListener = () => {
            if ('getBattery' in navigator) {
                navigator.getBattery().then(battery => {
                    isCharging = battery.charging;
                    console.log(`Initial charging state: ${isCharging}`);
                    
                    // Listen for changes in charging status
                    battery.addEventListener('chargingchange', () => {
                        isCharging = battery.charging;
                        console.log(`Charging state changed: ${isCharging}`);
                        handleStateChange(); // Re-evaluate state on change
                    });
                    
                    // Initial check
                    handleStateChange();
                });
            } else {
                console.log('Battery Status API not supported. Standby will work without charging check.');
                isCharging = true; // Assume it's always "charging" to allow functionality
                handleStateChange();
            }
        };

        // --- Event Listeners and Initialisation ---
        screen.orientation.addEventListener('change', handleStateChange);
        window.addEventListener('load', () => {
            setupBatteryListener();
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js');
            }
        });
    </script>
</body>
</html>
